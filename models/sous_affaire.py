from odoo import models, fields, api
from odoo.exceptions import ValidationError

class InspectionSousAffaire(models.Model):
    _name = 'kes_inspections.sous_affaire'
    _description = 'Sous-affaire dInspection'
    _order = 'create_date desc'
    
    # ğŸ”¹ CHAMPS PRINCIPAUX SIMPLIFIÃ‰S
    name = fields.Char(string='RÃ©fÃ©rence sous-affaire', required=True, copy=False, default='Nouvelle')
    affaire_id = fields.Many2one('kes_inspections.affaire', string='Affaire parente', required=True, ondelete='cascade')
    description = fields.Text(string='Description')
    date_creation = fields.Datetime(string='Date crÃ©ation', default=fields.Datetime.now, readonly=True)

    # ğŸ”¹ DOCUMENTS UNIQUES (1 par sous-affaire)
    bond_commande_ids = fields.One2many(
        'kes_inspections.bond_commande',
        'sous_affaire_id',
        string='Bond de commande',
    )

    pv_ids = fields.One2many(
        'kes_inspections.pv',
        'sous_affaire_id',
        string='ProcÃ¨s-verbaux',
    )

    enquete_satisfaction_ids = fields.One2many(
        'kes_inspections.enquete_satisfaction',
        'sous_affaire_id',
        string='EnquÃªtes de satisfaction',
    )

    
    state = fields.Selection([
        ('draft', 'Brouillon'),
        ('in_progress', 'En cours'),
        ('done', 'TerminÃ©e'),
    ], default='draft', string='Statut', tracking=True)
    
    # ğŸ”¹ CHARGÃ‰ D'AFFAIRE PRINCIPAL (LIÃ‰ Ã€ L'AFFAIRE)
    charge_affaire_principal = fields.Many2one(
        'hr.employee',
        string='ChargÃ© d\'affaire principal',
        related='affaire_id.charge_affaire_id',
        readonly=True
    )

    produit_etiquette_ids = fields.One2many(
        'kes_inspections.sous_affaire_produit',
        'sous_affaire_id',
        string='GÃ©nÃ©ration d\'Ã©tiquettes par produit'
    )
    
    # ğŸ”¹ INSPECTEURS ASSIGNÃ‰S (NOUVEAU MODÃˆLE)
    inspecteur_ids = fields.One2many(
        'kes_inspections.sous_affaire_inspecteur',
        'sous_affaire_id',
        string='Inspecteurs assignÃ©s'
    )
    
    # ğŸ”¹ RÃ‰SUMÃ‰ DE LA MISSION
    point_focal_client_id = fields.Many2one(
        'res.partner',
        string='Point focal client',
        domain="[('parent_id', '=', client_id)]"
    )
    site_intervention = fields.Char(string='Site d\'intervention', related='affaire_id.site_intervention', readonly=True)
    lieu_intervention = fields.Char(string='Lieu', related='affaire_id.lieu_intervention', readonly=True)
    description_mission = fields.Text(string='Description de la mission')
    
    # ğŸ”¹ TYPES D'INTERVENTION (PRODUITS DE LA COMMANDE)
    type_intervention_ids = fields.Many2many(
        'product.product',
        string='Types d\'intervention',
        compute='_compute_types_intervention',
        store=True
    )

    # ğŸ”¹ RELATIONS EXISTANTES
    etiquette_ids = fields.One2many('kes_inspections.etiquette', 'sous_affaire_id', string='Ã‰tiquettes')
    rapport_ids = fields.One2many('kes_inspections.rapport', 'sous_affaire_id', string='Rapports')
    
    # ğŸ”¹ COMPTEURS
    etiquette_count = fields.Integer(string='Nombre d\'Ã©tiquettes', compute='_compute_etiquette_count')
    rapport_count = fields.Integer(string='Nombre de rapports', compute='_compute_rapport_count')
    inspecteur_count = fields.Integer(string='Nombre d\'inspecteurs', compute='_compute_inspecteur_count')

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¸ MÃ‰THODES DE CALCUL
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    @api.depends('affaire_id', 'affaire_id.sale_order_id', 'affaire_id.sale_order_id.order_line')
    def _compute_types_intervention(self):
        """RÃ©cupÃ¨re les produits de la commande de vente liÃ©e"""
        for sous_affaire in self:
            if sous_affaire.affaire_id and sous_affaire.affaire_id.sale_order_id:
                products = sous_affaire.affaire_id.sale_order_id.order_line.mapped('product_id')
                sous_affaire.type_intervention_ids = [(6, 0, products.ids)]
            else:
                sous_affaire.type_intervention_ids = [(5, 0, 0)]

    @api.depends('etiquette_ids')
    def _compute_etiquette_count(self):
        for sous_affaire in self:
            sous_affaire.etiquette_count = len(sous_affaire.etiquette_ids)

    @api.depends('rapport_ids')
    def _compute_rapport_count(self):
        for sous_affaire in self:
            sous_affaire.rapport_count = len(sous_affaire.rapport_ids)

    @api.depends('inspecteur_ids')
    def _compute_inspecteur_count(self):
        for sous_affaire in self:
            sous_affaire.inspecteur_count = len(sous_affaire.inspecteur_ids)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¸ MÃ‰THODES CRUD
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    @api.model
    def create(self, vals):
        if vals.get('name', 'Nouvelle') == 'Nouvelle':
            if vals.get('affaire_id'):
                affaire = self.env['kes_inspections.affaire'].browse(vals['affaire_id'])
                existing_count = self.search_count([('affaire_id', '=', vals['affaire_id'])])
                numero = existing_count + 1
                vals['name'] = f"{affaire.name}/SA{str(numero).zfill(3)}"
        
        # Assigner automatiquement le chargÃ© d'affaire comme inspecteur par dÃ©faut
        sous_affaire = super().create(vals)
        
        # CrÃ©er l'entrÃ©e pour le chargÃ© d'affaire principal
        if sous_affaire.charge_affaire_principal:
            self.env['kes_inspections.sous_affaire_inspecteur'].create({
                'sous_affaire_id': sous_affaire.id,
                'inspecteur_id': sous_affaire.charge_affaire_principal.id,
                'role': 'site_rapport'
            })
        
        return sous_affaire

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¸ ACTIONS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    def action_voir_inspecteurs(self):
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': f'Inspecteurs - {self.name}',
            'res_model': 'kes_inspections.sous_affaire_inspecteur',
            'view_mode': 'list,form',
            'domain': [('sous_affaire_id', '=', self.id)],
            'context': {'default_sous_affaire_id': self.id}
        }

    def action_voir_etiquettes(self):
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': f'Ã‰tiquettes - {self.name}',
            'res_model': 'kes_inspections.etiquette',
            'view_mode': 'list,form',
            'domain': [('sous_affaire_id', '=', self.id)],
            'context': {'default_sous_affaire_id': self.id}
        }

    def action_voir_rapports(self):
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': f'Rapports - {self.name}',
            'res_model': 'kes_inspections.rapport',
            'view_mode': 'list,form',
            'domain': [('sous_affaire_id', '=', self.id)],
            'context': {'default_sous_affaire_id': self.id}
        }
    
    def action_download_bond_commande(self):
        """TÃ©lÃ©charge le bond de commande"""
        self.ensure_one()
        if not self.bond_commande_file:
            raise ValidationError("Aucun bond de commande Ã  tÃ©lÃ©charger.")
        
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/kes_inspections.sous_affaire/{self.id}/bond_commande_file?download=true",
            'target': 'self',
        }
    
    def action_download_pv(self):
        """TÃ©lÃ©charge le PV"""
        self.ensure_one()
        if not self.pv_file:
            raise ValidationError("Aucun PV Ã  tÃ©lÃ©charger.")
        
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/kes_inspections.sous_affaire/{self.id}/pv_file?download=true",
            'target': 'self',
        }
    
    def action_download_enquete(self):
        """TÃ©lÃ©charge l'enquÃªte de satisfaction"""
        self.ensure_one()
        if not self.enquete_satisfaction_file:
            raise ValidationError("Aucune enquÃªte de satisfaction Ã  tÃ©lÃ©charger.")
        
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/kes_inspections.sous_affaire/{self.id}/enquete_satisfaction_file?download=true",
            'target': 'self',
        }
    
    # ğŸ”¹ CORRECTION : Ajouter le champ client_id manquant
    client_id = fields.Many2one(
        'res.partner',
        string='Client',
        related='affaire_id.client_id',
        readonly=True,
        store=True
    )

    def action_generer_toutes_etiquettes(self):
        """GÃ©nÃ¨re les Ã©tiquettes pour tous les produits configurÃ©s"""
        self.ensure_one()
        
        if not self.produit_etiquette_ids:
            raise ValidationError("Aucun produit configurÃ© pour la gÃ©nÃ©ration d'Ã©tiquettes.")
        
        etiquettes_crees = 0
        for produit_line in self.produit_etiquette_ids:
            if produit_line.nombre_etiquettes > 0:
                try:
                    etiquettes_crees += produit_line.generer_etiquettes()
                except Exception as e:
                    raise ValidationError(f"Erreur lors de la gÃ©nÃ©ration pour {produit_line.product_id.name}: {str(e)}")
        
        if etiquettes_crees > 0:
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': 'Ã‰tiquettes gÃ©nÃ©rÃ©es',
                    'message': f'{etiquettes_crees} Ã©tiquette(s) gÃ©nÃ©rÃ©e(s) avec succÃ¨s',
                    'sticky': False,
                }
            }
        else:
            raise ValidationError("Aucune Ã©tiquette gÃ©nÃ©rÃ©e. VÃ©rifiez les quantitÃ©s configurÃ©es.")

    def action_download_all_etiquettes(self):
        """TÃ©lÃ©charge toutes les Ã©tiquettes en fichier ZIP"""
        self.ensure_one()
        if not self.etiquette_ids:
            raise ValidationError("Aucune Ã©tiquette Ã  tÃ©lÃ©charger.")
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'FonctionnalitÃ© Ã  venir',
                'message': 'Le tÃ©lÃ©chargement ZIP sera disponible prochainement',
                'sticky': False,
            }
        }
    

class KesBondCommande(models.Model):
    _name = 'kes_inspections.bond_commande'
    _description = 'Bond de commande'

    sous_affaire_id = fields.Many2one(
        'kes_inspections.sous_affaire',
        string='Sous-affaire',
        required=True,
        ondelete='cascade'
    )

    bond_commande_filename = fields.Char(string='Nom du fichier', required=True)
    bond_commande_file = fields.Binary(string='Fichier bond de commande', required=True)
    date_upload = fields.Datetime(string='Date d\'envoi', default=fields.Datetime.now)

    def action_download_bond_commande(self):
        """TÃ©lÃ©charger le bond de commande"""
        self.ensure_one()
        if not self.bond_commande_file:
            raise ValidationError("Aucun fichier Ã  tÃ©lÃ©charger.")
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/{self._name}/{self.id}/bond_commande_file?download=true",
            'target': 'self',
        }


class KesPV(models.Model):
    _name = 'kes_inspections.pv'
    _description = 'ProcÃ¨s-verbal'

    sous_affaire_id = fields.Many2one(
        'kes_inspections.sous_affaire',
        string='Sous-affaire',
        required=True,
        ondelete='cascade'
    )

    pv_filename = fields.Char(string='Nom du fichier', required=True)
    pv_file = fields.Binary(string='Fichier PV', required=True)
    date_upload = fields.Datetime(string='Date d\'envoi', default=fields.Datetime.now)

    def action_download_pv(self):
        """TÃ©lÃ©charger le PV"""
        self.ensure_one()
        if not self.pv_file:
            raise ValidationError("Aucun fichier Ã  tÃ©lÃ©charger.")
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/{self._name}/{self.id}/pv_file?download=true",
            'target': 'self',
        }


class KesEnqueteSatisfaction(models.Model):
    _name = 'kes_inspections.enquete_satisfaction'
    _description = 'EnquÃªte de satisfaction'

    sous_affaire_id = fields.Many2one(
        'kes_inspections.sous_affaire',
        string='Sous-affaire',
        required=True,
        ondelete='cascade'
    )

    enquete_satisfaction_filename = fields.Char(string='Nom du fichier', required=True)
    enquete_satisfaction_file = fields.Binary(string='Fichier enquÃªte satisfaction', required=True)
    date_upload = fields.Datetime(string='Date d\'envoi', default=fields.Datetime.now)

    def action_download_enquete(self):
        """TÃ©lÃ©charger le fichier d'enquÃªte"""
        self.ensure_one()
        if not self.enquete_satisfaction_file:
            raise ValidationError("Aucun fichier Ã  tÃ©lÃ©charger.")
        return {
            'type': 'ir.actions.act_url',
            'url': f"/web/content/{self._name}/{self.id}/enquete_satisfaction_file?download=true",
            'target': 'self',
        }
